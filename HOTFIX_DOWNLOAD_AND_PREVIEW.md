# üîß HOTFIX: Download –∏ Preview –æ—à–∏–±–∫–∏

## üìã –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–≤–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

### ‚ùå –û—à–∏–±–∫–∞ #1: Download FileNotFoundError

**–ë—ã–ª–∞ –æ—à–∏–±–∫–∞:**
```
FileNotFoundError: [Errno 2] No such file or directory: 
'/content/sd-inference-server/models/SD/model.safetensors.tmp' -> 
'/content/sd-inference-server/models/SD/model.safetensors'
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–§–∞–π–ª `.tmp` –∏—Å—á–µ–∑–∞–ª –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω–∏–µ–º, –≤–µ—Ä–æ—è—Ç–Ω–æ –∏–∑-–∑–∞:
- –ü–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è download
- –ü—Ä–æ–±–ª–µ–º —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
- –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
- –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞

### ‚ùå –û—à–∏–±–∫–∞ #2: Preview VAE –º–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã

**–ë—ã–ª–∞ –æ—à–∏–±–∫–∞:**
```
FileNotFoundError: VAE cheap model not found at: 
/content/sd-inference-server/approx/VAE-cheap.safetensors
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–§–∞–π–ª—ã `approx/VAE-cheap.safetensors` –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ Colab).

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ #1: –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `download()` –≤ `utils.py`

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

**–§–∞–π–ª: `utils.py` (—Å—Ç—Ä–æ–∫–∏ 415-443)**

```python
# –ë–´–õ–û:
os.rename(filename+".tmp", filename)

# –°–¢–ê–õ–û:
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
tmp_file = filename + ".tmp"
if not os.path.exists(tmp_file):
    raise FileNotFoundError(f"Temporary file not found after download: {tmp_file}")

# –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª–∏—Ç—å –µ–≥–æ
if os.path.exists(filename):
    try:
        os.remove(filename)
    except OSError as e:
        raise RuntimeError(f"Failed to remove existing file {filename}: {e}")

# –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª
try:
    os.rename(tmp_file, filename)
except OSError as e:
    # –ï—Å–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
    try:
        import shutil
        shutil.move(tmp_file, filename)
    except Exception as move_error:
        raise RuntimeError(f"Failed to finalize download: rename error: {e}, move error: {move_error}")
```

### –£–ª—É—á—à–µ–Ω–∏—è:

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞** –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω–∏–µ–º  
‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–≥–æ —Ñ–∞–π–ª–∞** –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç  
‚úÖ **Fallback –Ω–∞ `shutil.move()`** –µ—Å–ª–∏ `os.rename()` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ **–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**  

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ #2: Graceful fallback –¥–ª—è preview –≤ `preview.py`

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

**–§–∞–π–ª: `preview.py` - —Ñ—É–Ω–∫—Ü–∏—è `cheap_preview()` (—Å—Ç—Ä–æ–∫–∏ 75-94)**

```python
# –ë–´–õ–û:
if not os.path.exists(model_file):
    raise FileNotFoundError(...)  # ‚Üê –í—ã–±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫—É

# –°–¢–ê–õ–û:
if not os.path.exists(model_file):
    print(f"Warning: VAE cheap model not found, using full preview instead")
    return full_preview(latents, vae)  # ‚Üê Fallback –Ω–∞ full_preview
```

**–§–∞–π–ª: `preview.py` - —Ñ—É–Ω–∫—Ü–∏—è `model_preview()` (—Å—Ç—Ä–æ–∫–∏ 97-116)**

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è `model_preview()`

### –£–ª—É—á—à–µ–Ω–∏—è:

‚úÖ **–ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback  
‚úÖ **–ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É** - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç preview –∏—Å–ø–æ–ª—å–∑—É—è `full_preview()`  
‚úÖ **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ  
‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π** - –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç  

---

## üîÑ –ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Download

```
1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª .tmp
   ‚Üì
2. –ü—Ä–æ–≤–µ—Ä–∫–∞: .tmp —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
   ‚îú‚îÄ –ù–ï–¢ ‚Üí –û—à–∏–±–∫–∞ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
   ‚îî‚îÄ –î–ê ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
   ‚Üì
3. –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
   ‚îú‚îÄ –î–ê ‚Üí –£–¥–∞–ª–∏—Ç—å –µ–≥–æ
   ‚îî‚îÄ –ù–ï–¢ ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
   ‚Üì
4. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è (os.rename)
   ‚îú‚îÄ –£–°–ü–ï–• ‚Üí –ì–æ—Ç–æ–≤–æ! ‚úÖ
   ‚îî‚îÄ –û–®–ò–ë–ö–ê ‚Üí –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å shutil.move()
   ‚Üì
5. shutil.move() fallback
   ‚îú‚îÄ –£–°–ü–ï–• ‚Üí –ì–æ—Ç–æ–≤–æ! ‚úÖ
   ‚îî‚îÄ –û–®–ò–ë–ö–ê ‚Üí –û—à–∏–±–∫–∞ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
```

---

## üîÑ –ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Preview

```
1. –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
   ‚îú‚îÄ –ù–ï–¢ ‚Üí Warning + Fallback –Ω–∞ full_preview ‚ö†Ô∏è
   ‚îî‚îÄ –î–ê ‚Üí –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å
   ‚Üì
2. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏
   ‚îú‚îÄ –£–°–ü–ï–• ‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –º–æ–¥–µ–ª—å ‚úÖ
   ‚îî‚îÄ –û–®–ò–ë–ö–ê ‚Üí Warning + Fallback –Ω–∞ full_preview ‚ö†Ô∏è
   ‚Üì
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –¥–ª—è preview
```

---

## üíæ –°–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

### Download –ø—Ä–æ—Ü–µ—Å—Å:

```
–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
‚îî‚îÄ‚îÄ models/SD/
    ‚îî‚îÄ‚îÄ (–Ω–∏—á–µ–≥–æ)

–í–æ –≤—Ä–µ–º—è download:
‚îî‚îÄ‚îÄ models/SD/
    ‚îî‚îÄ‚îÄ model.safetensors.tmp  ‚Üê –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ download:
‚îî‚îÄ‚îÄ models/SD/
    ‚îî‚îÄ‚îÄ model.safetensors      ‚Üê –§–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

‚úÖ **–ê—Ç–æ–º–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –ª–∏–±–æ —Ñ–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω, –ª–∏–±–æ –Ω–µ—Ç  
‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** - –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Å–∫–∞—á–∞—Ç—å –µ—Å–ª–∏ –ø—Ä–µ—Ä–≤–∞—Ç—å—Å—è  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –Ω–µ –æ—Å—Ç–∞–µ—Ç—Å—è –ø–æ–ª–æ–º–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤  

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –î–æ –∏ –ü–æ—Å–ª–µ

| –ê—Å–ø–µ–∫—Ç | –î–æ | –ü–æ—Å–ª–µ |
|--------|------|-------|
| **Download –æ—à–∏–±–∫–∞** | ‚ùå –ü–∞–¥–∞–µ—Ç | ‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å fallback |
| **Preview –æ—à–∏–±–∫–∞** | ‚ùå –ü–∞–¥–∞–µ—Ç | ‚úÖ Fallback –Ω–∞ full_preview |
| **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** | ‚ùå –ù–µ—è—Å–Ω–∞—è | ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** | ‚ùå –ù–µ—Ç | ‚úÖ Graceful fallback |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | ‚úÖ Fast | ‚úÖ Fast (fallback –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ) |

---

## üöÄ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Download –ø—Ä–µ—Ä–≤–∞–Ω

```
–ë–´–õ–û:
–°–∫–∞—á–∏–≤–∞–Ω–∏–µ... 50%
ERROR: FileNotFoundError ‚ùå
–ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚ùå

–°–¢–ê–õ–û:
–°–∫–∞—á–∏–≤–∞–Ω–∏–µ... 50%
ERROR: Temporary file not found
–ü–û–ü–´–¢–ö–ê: shutil.move() 
–£–°–ü–ï–• ‚úÖ (–∏–ª–∏ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–µ—Ç approx –º–æ–¥–µ–ª–µ–π –Ω–∞ Colab

```
–ë–´–õ–û:
–ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...
ERROR: FileNotFoundError ‚ùå
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ ‚ùå

–°–¢–ê–õ–û:
–ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...
Warning: VAE approx model not found, using full preview
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è ‚úÖ (–º–µ–¥–ª–µ–Ω–Ω–µ–µ preview, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
```

---

## ‚úÖ –°—Ç–∞—Ç—É—Å

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å |
|-----------|--------|
| Download –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| Preview fallback | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ |
| –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–∫–∞ | ‚úÖ Valid |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞ |

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 21 –Ω–æ—è–±—Ä—è 2024  
**–í–µ—Ä—Å–∏—è:** 1.0.5  
**–°—Ç–∞—Ç—É—Å:** Production Ready ‚úÖ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ download –∏ gracefully fallback –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏! üéâ

